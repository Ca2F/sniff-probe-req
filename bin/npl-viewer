#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import urwid
from sniff_probe_req.probe_request_sniffer import ProbeRequestSniffer

class ProbeRequestSnifferTUI:
    palette = [
        ("header_running", "white", "dark green", "bold"),
        ("header_stopped", "white", "dark red", "bold"),
        ("footer", "dark cyan", "dark blue", "bold"),
        ("key", "light cyan", "dark blue", "underline"),
        ("selected", "black", "light green"),
    ]

    footer_text = ("footer", [
        "    ",
        ("key", "P"), " play/pause  ",
        ("key", "Q"), " quit",
    ])

    def __init__(self):
        self.interface = urwid.Text("wlan0")
        self.sniffer_running = False

        self.stations = [
            "Station 1",
            "Station 2",
            "Station 3",
        ]

        self.pnl = [
            urwid.Text("ESSID 1"),
            urwid.Text("ESSID 2"),
            urwid.Text("ESSID 3"),
        ]

        self.view = self.setup_view()

    def setup_view(self):
        self.sniffer_state_text = urwid.Text("Stopped")

        self.header = urwid.AttrWrap(urwid.Columns([
            urwid.Text("Sniffer state: "),
            self.sniffer_state_text,
            urwid.Text(" Interface: "),
            self.interface,
        ]), "header_stopped")
        footer = urwid.AttrWrap(urwid.Text(self.footer_text), "footer")
        vline = urwid.AttrWrap(urwid.SolidFill(u'\u2502'), 'line')

        stations_menu = urwid.Padding(self.setup_menu("List of Stations", self.stations), left=4, right=4)
        pnl_list = urwid.ListBox(self.pnl)

        body = urwid.Columns([
            stations_menu,
            ("fixed", 1, vline),
            pnl_list,
        ], focus_column=1)

        top = urwid.Frame(
            header=self.header,
            body=body,
            footer=footer,
            focus_part = "body"
        )

        return top

    def setup_menu(self, title, choices):
        body = [urwid.Text(title), urwid.Divider()]

        for c in choices:
            button = urwid.Button(c)
            urwid.connect_signal(button, "click", self.station_chosen, c)
            body.append(urwid.AttrMap(button, None, focus_map="selected"))

        return urwid.ListBox(urwid.SimpleFocusListWalker(body))

    def station_chosen(self, button, choice):
        pass

    def start_sniffer(self):
        self.sniffer_running = True
        self.sniffer_state_text.set_text("Running")
        self.header.set_attr("header_running");

    def stop_sniffer(self):
        self.sniffer_running = False
        self.sniffer_state_text.set_text("Stopped")
        self.header.set_attr("header_stopped");

    def toggle_sniffer_state(self):
        if self.sniffer_running:
            self.stop_sniffer()
        else:
            self.start_sniffer()

    def main(self):
        self.loop = urwid.MainLoop(self.view, self.palette, unhandled_input=self.unhandled_keypress)
        self.loop.run()

    def exit_program(self):
        raise urwid.ExitMainLoop()

    def unhandled_keypress(self, key):
        if key in ("q", "Q"):
            self.exit_program()
        elif key in ("p", "P"):
            self.toggle_sniffer_state()
        else:
            return

        return True

if __name__ == "__main__":
    ProbeRequestSnifferTUI().main()
